version: '3.8'

services:
  strapi_db:
    image: postgres:13.3-alpine
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    networks:
      - richardwillis
    healthcheck:
      test: ['CMD', 'pg_isready']
    environment:
      - POSTGRES_DB=strapi
      - POSTGRES_USER_FILE=/run/secrets/richardwillis-postgres-user
      - POSTGRES_PASSWORD_FILE=/run/secrets/richardwillis-postgres-password
    secrets:
      - richardwillis-postgres-password
      - richardwillis-postgres-user
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - 'traefik.enable=false'

  plausible_db:
    image: postgres:13.3-alpine
    volumes:
      - plausible-db-data:/var/lib/postgresql/data
    networks:
      - plausible
    healthcheck:
      test: ['CMD', 'pg_isready']
    environment:
      - POSTGRES_DB=plausible
      - POSTGRES_USER_FILE=/run/secrets/richardwillis-plausible-postgres-user
      - POSTGRES_PASSWORD_FILE=/run/secrets/richardwillis-plausible-postgres-password
    secrets:
      - richardwillis-plausible-postgres-password
      - richardwillis-plausible-postgres-user
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - 'traefik.enable=false'

  plausible_events_db:
    image: yandex/clickhouse-server:21.3.2.5
    volumes:
      - plausible-event-data:/var/lib/clickhouse
      - plausible-etc-clickhouse-server:/etc/clickhouse-server
    networks:
      - plausible
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - 'traefik.enable=false'

  plausible:
    image: plausible/analytics:master@sha256:adfc5f693e8d70d48b04fc17b009b2871b9ee23d9a349e606eab708e964d2a60
    command: sh -c "/entrypoint.sh db createdb && /entrypoint.sh db migrate && /entrypoint.sh db init-admin && /entrypoint.sh run"
    networks:
      - plausible
      - traefik-public
    environment:
      - CONFIG_DIR=/run/secrets
    healthcheck:
      test:
        ['CMD', 'wget', '-q', '--tries=1', '--spider', 'http://localhost:8000']
    secrets:
      - source: richardwillis-plausible-admin-user-email
        target: /run/secrets/ADMIN_USER_EMAIL
      - source: richardwillis-plausible-admin-user-name
        target: /run/secrets/ADMIN_USER_NAME
      - source: richardwillis-plausible-admin-user-password
        target: /run/secrets/ADMIN_USER_PWD
      - source: richardwillis-plausible-base-url
        target: /run/secrets/BASE_URL
      - source: richardwillis-plausible-secret-key-base
        target: /run/secrets/SECRET_KEY_BASE
      - source: richardwillis-plausible-database-url
        target: /run/secrets/DATABASE_URL
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - 'traefik.enable=true'
        - 'traefik.docker.lbswarm=true'
        - 'traefik.http.routers.plausible.entrypoints=web'
        - 'traefik.http.routers.plausible.rule=Host(`plausible.docker-box.richardwillis.info`)'
        - 'traefik.http.services.plausible-service.loadbalancer.server.port=8000'
        - 'traefik.http.middlewares.plausible-redirectscheme.redirectscheme.permanent=true'
        - 'traefik.http.middlewares.plausible-redirectscheme.redirectscheme.scheme=https'
        - 'traefik.http.routers.plausible.middlewares=plausible-redirectscheme'
        - 'traefik.http.routers.plausible-secure.entrypoints=websecure'
        - 'traefik.http.routers.plausible-secure.rule=Host(`plausible.docker-box.richardwillis.info`)'
        - 'traefik.http.routers.plausible-secure.tls.certresolver=letsencrypt'

  actions_proxy:
    image: ghcr.io/badsyntax/strapi-webhook-actions-proxy:latest
    networks:
      - richardwillis
    secrets:
      - source: richardwillis-actions-proxy-env
        target: /app/.env
        uid: '0'
        gid: '0'
        mode: 444
    deploy:
      mode: replicated
      replicas: 2
      labels:
        - 'traefik.enable=false'

  nextjs:
    image: registry.docker-box.richardwillis.info/badsyntax/richardwillis.info:latest
    networks:
      - traefik-public
    healthcheck:
      test:
        ['CMD', 'wget', '-q', '--tries=1', '--spider', 'http://localhost:80']
    deploy:
      mode: replicated
      replicas: 2
      labels:
        - 'traefik.enable=true'
        - 'traefik.docker.lbswarm=true'
        - 'traefik.http.routers.richardwillis.entrypoints=web'
        - 'traefik.http.routers.richardwillis.rule=Host(`richardwillis.docker-box.richardwillis.info`, `richardwillis.info`)'
        - 'traefik.http.services.richardwillis-service.loadbalancer.server.port=80'
        - 'traefik.http.middlewares.richardwillis-redirectscheme.redirectscheme.permanent=true'
        - 'traefik.http.middlewares.richardwillis-redirectscheme.redirectscheme.scheme=https'
        - 'traefik.http.routers.richardwillis.middlewares=richardwillis-redirectscheme'
        - 'traefik.http.routers.richardwillis-secure.entrypoints=websecure'
        - 'traefik.http.routers.richardwillis-secure.rule=Host(`richardwillis.docker-box.richardwillis.info`, `richardwillis.info`)'
        - 'traefik.http.routers.richardwillis-secure.tls.certresolver=letsencrypt'

  strapi:
    image: registry.docker-box.richardwillis.info/badsyntax/richardwillis.info-strapi:latest
    networks:
      - traefik-public
      - richardwillis
    healthcheck:
      test:
        ['CMD', 'wget', '-q', '--tries=1', '--spider', 'http://localhost:3000']
    volumes:
      - strapi-uploads:/app/public/uploads
    secrets:
      - source: richardwillis-strapi-config
        target: /app/.env
        uid: '0'
        gid: '0'
        mode: 444
    deploy:
      mode: replicated
      replicas: 2
      labels:
        - 'traefik.enable=true'
        - 'traefik.docker.lbswarm=true'
        - 'traefik.http.routers.strapi.entrypoints=web'
        - 'traefik.http.routers.strapi.rule=Host(`strapi.docker-box.richardwillis.info`)'
        - 'traefik.http.services.strapi-service.loadbalancer.server.port=3000'
        - 'traefik.http.middlewares.strapi-redirectscheme.redirectscheme.permanent=true'
        - 'traefik.http.middlewares.strapi-redirectscheme.redirectscheme.scheme=https'
        - 'traefik.http.routers.strapi.middlewares=strapi-redirectscheme'
        - 'traefik.http.routers.strapi-secure.entrypoints=websecure'
        - 'traefik.http.routers.strapi-secure.rule=Host(`strapi.docker-box.richardwillis.info`)'
        - 'traefik.http.routers.strapi-secure.tls.certresolver=letsencrypt'

networks:
  traefik-public:
    external: true
  richardwillis:
    driver: overlay
    attachable: true
  plausible:
    driver: overlay
    attachable: true

secrets:
  richardwillis-postgres-password:
    external: true
  richardwillis-postgres-user:
    external: true
  richardwillis-strapi-config:
    external: true
  richardwillis-actions-proxy-env:
    external: true
  richardwillis-plausible-admin-user-email:
    external: true
  richardwillis-plausible-admin-user-name:
    external: true
  richardwillis-plausible-admin-user-password:
    external: true
  richardwillis-plausible-base-url:
    external: true
  richardwillis-plausible-secret-key-base:
    external: true
  richardwillis-plausible-postgres-user:
    external: true
  richardwillis-plausible-postgres-password:
    external: true
  richardwillis-plausible-database-url:
    external: true

volumes:
  postgres-data:
  strapi-uploads:
  plausible-db-data:
  plausible-event-data:
  plausible-etc-clickhouse-server:
